var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,s=(t,i,n)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n,a=(e,t)=>{for(var i in t||(t={}))r.call(t,i)&&s(e,i,t[i]);if(n)for(var i of n(t))o.call(t,i)&&s(e,i,t[i]);return e},c=(e,n)=>t(e,i(n)),d=(e,t,i)=>s(e,"symbol"!=typeof t?t+"":t,i),u=(e,t,i)=>new Promise((n,r)=>{var o=e=>{try{a(i.next(e))}catch(t){r(t)}},s=e=>{try{a(i.throw(e))}catch(t){r(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,s);a((i=i.apply(e,t)).next())});import{s as l}from"./index-Chu0lAqN.js";const f=new class{constructor(){d(this,"sessionId"),d(this,"deviceFingerprint"),d(this,"initialized",!1),this.sessionId=this.generateSessionId(),this.deviceFingerprint=this.generateDeviceFingerprint(),this.waitForDOMAndInitialize()}waitForDOMAndInitialize(){"undefined"!=typeof window&&"undefined"!=typeof document&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initializeTracking()}):this.initializeTracking())}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateDeviceFingerprint(){if("undefined"==typeof window||"undefined"==typeof document||"undefined"==typeof navigator||"undefined"==typeof screen)return`server_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{const e=document.createElement("canvas"),t=e.getContext("2d");null==t||t.fillText("fingerprint",10,10);const i=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,(new Date).getTimezoneOffset(),!!window.sessionStorage,!!window.localStorage,!!window.indexedDB,e.toDataURL()].join("|");return btoa(i).substr(0,50)}catch(e){return`fallback_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}initializeTracking(){return u(this,null,function*(){if(!this.initialized&&(this.initialized=!0,"undefined"!=typeof window&&"undefined"!=typeof document))try{yield this.trackActivity("page_load",{page_title:document.title,load_time:performance.now()}),yield this.createSession(),this.setupEventListeners()}catch(e){console.error("Failed to initialize activity tracking:",e)}})}setupEventListeners(){if("undefined"!=typeof window&&"undefined"!=typeof document)try{document.addEventListener("visibilitychange",()=>{this.trackActivity("page_visibility_change",{hidden:document.hidden,visibility_state:document.visibilityState})}),window.addEventListener("beforeunload",()=>{this.trackActivity("page_unload",{time_spent:performance.now()})}),document.addEventListener("click",e=>{var t;const i=e.target;if(i){const e={tag_name:i.tagName,element_id:i.id,element_class:i.className,text_content:null==(t=i.textContent)?void 0:t.substr(0,100),href:i.getAttribute("href"),data_attributes:this.getDataAttributes(i)};this.trackActivity("element_click",e)}}),document.addEventListener("submit",e=>{const t=e.target;if(t){const e=new FormData(t),i={form_id:t.id,form_action:t.action,form_method:t.method,fields:Array.from(e.keys())};this.trackActivity("form_submit",i)}}),this.trackPaymentActivities()}catch(e){console.error("Failed to setup event listeners:",e)}}getDataAttributes(e){const t={};for(const i of e.attributes)i.name.startsWith("data-")&&(t[i.name]=i.value);return t}trackPaymentActivities(){if("undefined"!=typeof document)try{document.querySelectorAll('form[data-payment="true"]').forEach(e=>{e.addEventListener("input",t=>{var i,n;const r=t.target;"password"===r.type||(null==(i=r.name)?void 0:i.includes("cvv"))||(null==(n=r.name)?void 0:n.includes("card"))||this.trackActivity("payment_form_input",{field_name:r.name,field_type:r.type,form_id:e.id})})})}catch(e){console.error("Failed to setup payment activity tracking:",e)}}trackActivity(e,t,i){return u(this,null,function*(){try{let r=null;if("undefined"!=typeof window)try{const{data:{user:e}}=yield l.auth.getUser();r=(null==e?void 0:e.id)||null}catch(n){console.log("No authenticated user, tracking as guest")}const o="undefined"!=typeof window&&"undefined"!=typeof document&&"undefined"!=typeof navigator,s={user_id:r,session_id:i||this.sessionId,activity_type:e,activity_data:t,page_url:o?window.location.href:void 0,referrer_url:o?document.referrer:void 0,user_agent:o?navigator.userAgent:void 0,device_info:o?{screen_resolution:`${screen.width}x${screen.height}`,viewport:`${window.innerWidth}x${window.innerHeight}`,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language,platform:navigator.platform,cookie_enabled:navigator.cookieEnabled,online:navigator.onLine}:void 0},{error:a}=yield l.from("activity_logs").insert(s);a&&console.error("Failed to track activity:",a)}catch(r){console.error("Activity tracking error:",r)}})}createSession(){return u(this,null,function*(){try{let t=null;if("undefined"!=typeof window)try{const{data:{user:e}}=yield l.auth.getUser();t=(null==e?void 0:e.id)||null}catch(e){console.log("No authenticated user, creating guest session")}const i="undefined"!=typeof navigator,n={user_id:t,session_token:this.sessionId,user_agent:i?navigator.userAgent:void 0,device_fingerprint:this.deviceFingerprint},{error:r}=yield l.from("user_sessions").insert(n);r&&console.error("Failed to create session:",r)}catch(t){console.error("Session creation error:",t)}})}updateSession(e){return u(this,null,function*(){try{const{error:t}=yield l.from("user_sessions").update({page_views:e,events_count:e}).eq("session_token",this.sessionId);t&&console.error("Failed to update session:",t)}catch(t){console.error("Session update error:",t)}})}endSession(){return u(this,null,function*(){try{const{error:e}=yield l.from("user_sessions").update({end_time:(new Date).toISOString(),is_active:!1}).eq("session_token",this.sessionId);e&&console.error("Failed to end session:",e)}catch(e){console.error("Session end error:",e)}})}logAuditEvent(e){return u(this,null,function*(){try{let i=null;if("undefined"!=typeof window)try{const{data:{user:e}}=yield l.auth.getUser();i=(null==e?void 0:e.id)||null}catch(t){console.log("No authenticated user for audit event")}const n="undefined"!=typeof navigator,r=c(a({},e),{performed_by:i,ip_address:yield this.getClientIP(),user_agent:n?navigator.userAgent:void 0}),{error:o}=yield l.from("audit_logs").insert(r);o&&console.error("Failed to log audit event:",o)}catch(i){console.error("Audit logging error:",i)}})}getClientIP(){return u(this,null,function*(){try{return"unknown"}catch(e){return"unknown"}})}trackPaymentAttempt(e){return u(this,null,function*(){yield this.trackActivity("payment_attempt",c(a({},e),{timestamp:(new Date).toISOString()}))})}trackPaymentSuccess(e,t){return u(this,null,function*(){yield this.trackActivity("payment_success",{payment_id:e,amount:t,timestamp:(new Date).toISOString()})})}trackPaymentFailure(e,t){return u(this,null,function*(){yield this.trackActivity("payment_failure",c(a({reason:e},t),{timestamp:(new Date).toISOString()}))})}trackUserRegistration(e){return u(this,null,function*(){yield this.trackActivity("user_registration",e)})}trackSubscriptionChange(e,t){return u(this,null,function*(){yield this.trackActivity("subscription_change",{subscription_id:e,action:t,timestamp:(new Date).toISOString()})})}trackSupportTicket(e,t){return u(this,null,function*(){yield this.trackActivity("support_ticket",{ticket_id:e,action:t,timestamp:(new Date).toISOString()})})}};export{f as a};
